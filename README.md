# LayaBoxEsBuild

##  介绍

- 使用 esbuild 来构建 layabox 项目 优化开发体验。

## 关于 esBuild
- <a href="https://github.com/evanw/esbuild/">gitHub</a>
- esbuild 是一个用 Go 语言编写的用于打包，压缩 Javascript 代码的工具库。它最突出的特点就是打包速度极快 （extremely fast），下图是 esbuild 跟 webpack, rollup, Parcel 等打包工具打包效率的一个 benchmark:

  <img src="./public/2172142517-e6cf0caf23a0a851_fix732.png">

  图片取自 esbuild Github 仓库。
  
  #### 为什么它能做到那么快？

  有以下几个原因：

  它是用 Go 语言编写的，该语言可以编译为本地代码
  解析，生成最终打包文件和生成 source maps 的操作全部完全并行化
  无需昂贵的数据转换，只需很少的几步即可完成所有操作
  该库以提高编译速度为编写代码时的第一原则，并尽量避免不必要的内存分配
  更多详细介绍，详见 Breword 翻译的 esbuild 官方文档：https://www.breword.com/evanw-esbuild

## 为什么要用这个工具

- 之前用layaAir构建项目，电脑一般的话改了一行代码要到layaair编辑器中按f8编译然后大概等上1分多钟编译完成后再刷新浏览器才能看到改动效果，后来实在受不了了改用webpack编译，把编译时间缩短到了10几秒，而且不用到layaair中手动编译而是自动监听文件变化自动编译，但是由于webpack总是把项目打包到一个文件中所以项目一大的话它也要等上接近1分钟。而这个工具的优点就在于不编译，只构建，所以不管项目有多大，当你更改了文件并在按下ctrl+s的瞬间刷新浏览器就能看到改动效果。

## 实现方法

- 代码在.node/esbuild文件夹中，默认在vscode中被隐藏了的。

- 这里只是提供一种用esbuild构建项目的思路而已，最核心的是esbuild，方法多种多样，这里只是一个简单示例。

  - 在本地开一个文件服务代理某个目录下的文件访问。

  - 当有请求访问时就现在缓存中找这个模块，如果没有就创建这个模块。然后检查这个模块是不是最新版本，如果不是就构建一下，如果是就直接返回。

  - 当监听到文件变化时就在缓存中找地址和这个文件地址一样的模块然后修改它的版本，所以这里不会等待，因为没有异步操作。

  - 注意 在缓存中找模块时是通过对比地址找的，而且是不区分大小写的，如果不合适可以自己改查找方法。

## 使用方法

1. 拉取完项目后在该项目根目录下执行npm i 安装本地包，安装完成后再 执行 gulp installTPack 安装工具包。也可以使用npm脚本的安装本地包和安装工具包这两个快捷选项快捷安装。

2. 然后执行 cd .node/esbuild && ts-node -r tsconfig-paths/register src/main.ts 这个命令或者使用npm脚本的esbuild增量构建就可以开始了，当控制台输出主页地址 XXXX 的时候就表示esbuild准备完成，然后按f5打开浏览器并输入这个主页地址就可以看到项目了。

## 其他

- 更多快捷命令见 package.json中的 scripts 配置

- 尽量使用vscode编辑器来开发项目，应为这样就可以直接按f5打开浏览器进行调试，如果用其他开发工具的话需要在本地开一个局域网服务来调试。

- esbuild不依赖任何跟laya相关的东西，它只是代理了src这个目录并按需编译这个目录下的文件而已，对laya的任何升降级操作都不会对它造成影响，这里的laya项目只是个示例而已。

- 这个工具只是构建项目，不会把src的代码打包到bin/js/bundle.js文件里面而是缓存在内存中的，所以只能在开发环境中使用，最后在用laya的编译和打包，把代码都打包到bin/js/bundle.js文件中，它的作用就是优化开发体验，能更快的响应代码改动，不影响最终laya编译的结果。

- 最好把webpack的增量编译一起打开，因为esbuild只是构建不编译，所以在补个webpack的增量编译就完美了。